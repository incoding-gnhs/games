<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”¼ì•„ë…¸ íƒ€ì¼ ê²Œì„ v10</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: black;
        }

        .game-container {
            width: 400px;
            height: 600px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .game-header {
            height: 80px;
            background: #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 2px solid #ccc;
        }

        .score, .level, .speed {
            font-size: 18px;
            font-weight: bold;
        }

        .hearts {
            display: flex;
            gap: 5px;
            font-size: 24px;
        }

        .heart {
            color: #ff4444;
            transition: all 0.3s ease;
        }

        .heart.lost {
            color: #ccc;
            opacity: 0.3;
        }

        .timer {
            font-size: 18px;
            font-weight: bold;
            color: #ff4444;
        }

        .game-area {
            height: 440px;
            position: relative;
            overflow: hidden;
            background: white;
        }

        .lanes {
            display: flex;
            height: 100%;
            position: absolute;
            width: 100%;
        }

        .lane {
            flex: 1;
            border-right: 2px solid #ccc;
            position: relative;
            background: white;
        }

        .lane:last-child {
            border-right: none;
        }

        .judgment-line {
            position: absolute;
            bottom: 0px;
            left: 0;
            right: 0;
            height: 4px;
            background: #ff4444;
            z-index: 100;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .tile {
            position: absolute;
            width: calc(100% - 4px);
            height: 80px;
            background: black;
            margin: 2px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 32px;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.1s ease;
        }

        .tile.hit {
            background: #4CAF50;
            transform: scale(0.8);
            opacity: 0;
        }

        .controls {
            height: 80px;
            display: flex;
            background: #f0f0f0;
            border-top: 2px solid #ccc;
        }

        .key {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            border-right: 2px solid #ccc;
            cursor: pointer;
            transition: all 0.1s ease;
            background: white;
            color: black;
        }

        .key:last-child {
            border-right: none;
        }

        .key:hover {
            background: #e0e0e0;
        }

        .key.pressed {
            background: #d0d0d0;
            transform: scale(0.95);
        }

        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: white;
        }

        .game-over p {
            font-size: 18px;
            margin: 10px 0;
            color: white;
        }

        .restart-btn {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 18px;
            background: black;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 999;
        }

        .instructions h3 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .instructions p {
            font-size: 16px;
            margin: 5px 0;
            opacity: 0.8;
        }

        .start-btn {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 18px;
            background: black;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .miss-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s ease;
        }

        .miss-effect.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="score">ì ìˆ˜: <span id="score">0</span></div>
            <div class="hearts" id="hearts">
                <span class="heart">â™¥</span>
                <span class="heart">â™¥</span>
                <span class="heart">â™¥</span>
                <span class="heart">â™¥</span>
            </div>
            <div class="level">ë ˆë²¨: <span id="level">1</span></div>
            <div class="speed">ì†ë„: <span id="speed">1.0x</span></div>
            <div class="timer" id="timer" style="display: none;">30</div>
        </div>
        
        <div class="game-area">
            <div class="lanes">
                <div class="lane" data-lane="0"></div>
                <div class="lane" data-lane="1"></div>
                <div class="lane" data-lane="2"></div>
                <div class="lane" data-lane="3"></div>
            </div>
            <div class="judgment-line"></div>
            <div class="miss-effect" id="missEffect"></div>
        </div>
        
        <div class="controls">
            <div class="key" data-key="0">S</div>
            <div class="key" data-key="1">D</div>
            <div class="key" data-key="2">K</div>
            <div class="key" data-key="3">L</div>
        </div>

        <div class="instructions" id="instructions">
            <h3>í”¼ì•„ë…¸ íƒ€ì¼ ê²Œì„ v10</h3>
            <p>S, D, K, L í‚¤ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”</p>
            <p>í•˜íŠ¸ 4ê°œê°€ ëª¨ë‘ ì‚¬ë¼ì§€ë©´ ê²Œì„ì˜¤ë²„!</p>
            <p>ë ˆë²¨ 3~5ì—ì„œëŠ” ë™ì‹œ íƒ€ì¼ì´ ë‚˜ì˜µë‹ˆë‹¤!</p>
            <p>ë ˆë²¨ 10ì—ì„œ 30ì´ˆ ìƒì¡´í•˜ë©´ ìŠ¹ë¦¬!</p>
            <p>ë ˆë²¨ì´ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë” ì–´ë ¤ì›Œì§‘ë‹ˆë‹¤</p>
            <button class="start-btn" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
        </div>

        <div class="game-over" id="gameOver">
            <h2>ê²Œì„ ì˜¤ë²„!</h2>
            <p>ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></p>
            <p>ë‹¬ì„± ë ˆë²¨: <span id="finalLevel">1</span></p>
            <p>ì´ íƒ€ì¼ ìˆ˜: <span id="totalTiles">0</span></p>
            <button class="restart-btn" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
        </div>
    </div>

    <script>
        let gameState = {
            isRunning: false,
            score: 0,
            level: 1,
            speed: 1.0,
            tiles: [],
            nextTileId: 0,
            tilesCleared: 0,
            totalTiles: 200,
            keysPressed: [false, false, false, false],
            lastSpawnTime: [0, 0, 0, 0], // ê° ë ˆì¸ì˜ ë§ˆì§€ë§‰ ìŠ¤í° ì‹œê°„
            patternIndex: 0,
            currentPattern: []
        };

        const keys = ['KeyS', 'KeyD', 'KeyK', 'KeyL'];
        const lanes = document.querySelectorAll('.lane');
        const keyElements = document.querySelectorAll('.key');
        let gameLoop;
        let spawnLoop;

        // ë‹¤ì–‘í•œ íŒ¨í„´ ì •ì˜
        const singlePatterns = [
            // ë‹¨ì¼ íƒ€ì¼ íŒ¨í„´ë§Œ
            [[0], [1], [2], [3]],
            [[0], [0], [1], [1], [2], [2], [3], [3]],
            [[0], [3], [0], [3], [1], [2], [1], [2]],
            [[0], [3], [1], [2], [0], [3], [1], [2]],
            [[0], [1], [2], [3], [3], [2], [1], [0]],
            [[0], [2], [1], [3], [0], [3], [2], [1]],
            [[1], [2], [1], [2], [1], [2], [1], [2]],
            [[0], [3], [0], [3], [0], [3], [0], [3]],
            [[0], [1], [2], [3], [2], [1], [0], [1]],
            [[0], [0], [1], [2], [2], [3], [1], [3]],
        ];

        const doublePatterns = [
            // ë”ë¸” íƒ€ì¼ íŒ¨í„´ (ë ˆë²¨ 3-5 ì „ìš©)
            [[0, 1], [2, 3], [0, 2], [1, 3]],
            [[0, 3], [1, 2], [0, 3], [1, 2]],
            [[1], [2], [1], [2], [1, 2], [1], [2]],
            [[0], [3], [0], [3], [0, 3], [0], [3]],
            [[0, 1], [0], [1], [2, 3], [2], [3]],
            [[0, 2], [1, 3], [0, 3], [1, 2]],
        ];

        function getRandomPattern() {
            // ë ˆë²¨ 3~5ì¼ ë•Œë§Œ ë”ë¸” íŒ¨í„´ í¬í•¨
            if (gameState.level >= 3 && gameState.level <= 5) {
                const allPatterns = [...singlePatterns, ...doublePatterns];
                const patternIndex = Math.floor(Math.random() * allPatterns.length);
                return [...allPatterns[patternIndex]];
            } else {
                // ë ˆë²¨ 1-2, 6+ ì—ì„œëŠ” ì‹±ê¸€ íŒ¨í„´ë§Œ
                const patternIndex = Math.floor(Math.random() * singlePatterns.length);
                return [...singlePatterns[patternIndex]];
            }
        }

        function startGame() {
            document.getElementById('instructions').style.display = 'none';
            gameState.isRunning = true;
            gameState.score = 0;
            gameState.level = 1;
            gameState.speed = 1.0;
            gameState.tiles = [];
            gameState.nextTileId = 0;
            gameState.tilesCleared = 0;
            gameState.patternIndex = 0;
            gameState.currentPattern = getRandomPattern();
            gameState.hearts = 4;
            gameState.level10StartTime = null;
            gameState.level10Timer = null;
            
            updateDisplay();
            updateHearts();
            document.getElementById('timer').style.display = 'none';
            spawnTile();
            
            gameLoop = setInterval(updateGame, 16);
            spawnLoop = setInterval(spawnTile, 600 / gameState.speed);
        }

        function spawnTile() {
            if (gameState.tilesCleared >= gameState.totalTiles) {
                return;
            }

            // í˜„ì¬ íŒ¨í„´ì´ ëë‚¬ìœ¼ë©´ ìƒˆ íŒ¨í„´ ì„ íƒ
            if (gameState.patternIndex >= gameState.currentPattern.length) {
                gameState.currentPattern = getRandomPattern();
                gameState.patternIndex = 0;
            }

            // í˜„ì¬ íŒ¨í„´ì—ì„œ ìƒì„±í•  ë ˆì¸ë“¤ ê°€ì ¸ì˜¤ê¸°
            const lanesToSpawn = gameState.currentPattern[gameState.patternIndex];
            gameState.patternIndex++;

            // ê° ë ˆì¸ì— íƒ€ì¼ ìƒì„±
            lanesToSpawn.forEach(lane => {
                const tile = {
                    id: gameState.nextTileId++,
                    lane: lane,
                    y: -80,
                    hit: false
                };

                gameState.tiles.push(tile);
                
                const tileElement = document.createElement('div');
                tileElement.className = 'tile';
                tileElement.id = `tile-${tile.id}`;
                tileElement.style.top = `${tile.y}px`;
                tileElement.textContent = '0';
                
                lanes[lane].appendChild(tileElement);
            });
        }

        function updateGame() {
            if (!gameState.isRunning) return;

            // íƒ€ì¼ ì´ë™
            gameState.tiles.forEach(tile => {
                if (!tile.hit) {
                    tile.y += 3 * gameState.speed;
                    const tileElement = document.getElementById(`tile-${tile.id}`);
                    if (tileElement) {
                        tileElement.style.top = `${tile.y}px`;
                        
                        // íŒì •ì„ (ë°”ë‹¥)ì— ë‹¿ìœ¼ë©´ ê²Œì„ì˜¤ë²„
                        if (tile.y >= 440) {
                            gameOver();
                        }
                    }
                }
            });

            // íƒ€ì¼ ìˆœì„œ ì—…ë°ì´íŠ¸ (Yê°’ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬)
            updateTileNumbers();

            // í™”ë©´ ë°– íƒ€ì¼ ì œê±°
            gameState.tiles = gameState.tiles.filter(tile => {
                if (tile.y > 600 || tile.hit) {
                    const tileElement = document.getElementById(`tile-${tile.id}`);
                    if (tileElement) {
                        setTimeout(() => {
                            if (tileElement) tileElement.remove();
                        }, 150);
                    }
                    return false;
                }
                return true;
            });
        }

        function updateTileNumbers() {
            // ëª¨ë“  íƒ€ì¼ì„ Yê°’ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ì•„ë˜ìª½ì´ ë¨¼ì €)
            const sortedTiles = gameState.tiles
                .filter(tile => !tile.hit)
                .sort((a, b) => b.y - a.y);

            // Y ì¢Œí‘œê°€ ë¹„ìŠ·í•œ íƒ€ì¼ë“¤ì„ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ê¸° (ë™ì‹œì— ìƒì„±ëœ íƒ€ì¼)
            const groups = [];
            let currentGroup = [];
            let lastY = null;
            const yThreshold = 5; // Y ì¢Œí‘œ ì°¨ì´ê°€ 5 ì´í•˜ë©´ ê°™ì€ ê·¸ë£¹

            sortedTiles.forEach(tile => {
                if (lastY === null || Math.abs(tile.y - lastY) <= yThreshold) {
                    currentGroup.push(tile);
                } else {
                    if (currentGroup.length > 0) {
                        groups.push(currentGroup);
                    }
                    currentGroup = [tile];
                }
                lastY = tile.y;
            });
            
            if (currentGroup.length > 0) {
                groups.push(currentGroup);
            }

            // ê° ê·¸ë£¹ì— ìˆœì„œ ë²ˆí˜¸ ë¶€ì—¬
            groups.forEach((group, groupIndex) => {
                const orderNumber = groupIndex + 1;
                group.forEach(tile => {
                    const tileElement = document.getElementById(`tile-${tile.id}`);
                    if (tileElement) {
                        tileElement.textContent = `${orderNumber}`;
                    }
                });
            });
        }

        function hitTile(lane) {
            if (!gameState.isRunning) return;

            // ëª¨ë“  íƒ€ì¼ì„ Yê°’ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê·¸ë£¹ ì°¾ê¸°
            const sortedTiles = gameState.tiles
                .filter(tile => !tile.hit)
                .sort((a, b) => b.y - a.y);

            if (sortedTiles.length === 0) return;

            // ê°€ì¥ ì•„ë˜ìª½ íƒ€ì¼ë“¤ì˜ ê·¸ë£¹ ì°¾ê¸° (Y ì¢Œí‘œê°€ ë¹„ìŠ·í•œ íƒ€ì¼ë“¤)
            const yThreshold = 5;
            const bottomY = sortedTiles[0].y;
            const bottomGroup = sortedTiles.filter(tile => 
                Math.abs(tile.y - bottomY) <= yThreshold
            );

            // ëˆŒë¦° ë ˆì¸ì˜ íƒ€ì¼ì´ ê°€ì¥ ì•„ë˜ ê·¸ë£¹ì— ìˆëŠ”ì§€ í™•ì¸
            const targetTile = bottomGroup.find(tile => tile.lane === lane);

            if (targetTile) {
                // ì˜¬ë°”ë¥¸ íƒ€ì¼ì„ ëˆŒë €ì„ ë•Œ
                targetTile.hit = true;
                const tileElement = document.getElementById(`tile-${targetTile.id}`);
                if (tileElement) {
                    tileElement.classList.add('hit');
                }

                gameState.score += 10 * gameState.level;
                gameState.tilesCleared++;
                
                // ë ˆë²¨ì—… ì²´í¬ (20ê°œë§ˆë‹¤)
                if (gameState.tilesCleared % 20 === 0) {
                    levelUp();
                }
                
                updateDisplay();
                
                // ê²Œì„ ì™„ë£Œ ì²´í¬
                if (gameState.tilesCleared >= gameState.totalTiles) {
                    setTimeout(() => {
                        gameComplete();
                    }, 1000);
                }
            } else {
                // ì˜ëª»ëœ íƒ€ì¼ì„ ëˆŒë €ì„ ë•Œ (ìˆœì„œê°€ í‹€ë¦¼)
                showMissEffect();
                gameState.hearts--;
                updateHearts();
                
                // í•˜íŠ¸ê°€ 0ì´ ë˜ë©´ ê²Œì„ì˜¤ë²„
                if (gameState.hearts <= 0) {
                    gameOver();
                }
            }
        }

        function levelUp() {
            gameState.level++;
            gameState.speed = Math.min(3.0, 1.0 + (gameState.level - 1) * 0.2);
            
            // ë ˆë²¨ 10 ë„ë‹¬ ì‹œ íƒ€ì´ë¨¸ ì‹œì‘
            if (gameState.level === 10 && !gameState.level10StartTime) {
                gameState.level10StartTime = Date.now();
                document.getElementById('timer').style.display = 'block';
                startLevel10Timer();
            }
            
            // ìƒˆë¡œìš´ íŒ¨í„´ ì„ íƒ (ë ˆë²¨ì— ë”°ë¼ ë”ë¸” íŒ¨í„´ í¬í•¨ ì—¬ë¶€ê°€ ë‹¬ë¼ì§)
            gameState.currentPattern = getRandomPattern();
            gameState.patternIndex = 0;
            
            // ìŠ¤í° ê°„ê²© ì¡°ì • (ë ˆë²¨ 6 ì´ìƒì—ì„œëŠ” ì†ë„ ì¦ê°€ ì™„í™”)
            clearInterval(spawnLoop);
            let newSpawnRate;
            if (gameState.level <= 5) {
                newSpawnRate = Math.max(300, 600 - (gameState.level - 1) * 40);
            } else {
                // ë ˆë²¨ 6 ì´ìƒ: ë” ëŠë¦° ì†ë„ ì¦ê°€
                newSpawnRate = Math.max(400, 600 - 5 * 40 - (gameState.level - 6) * 20);
            }
            spawnLoop = setInterval(spawnTile, newSpawnRate / gameState.speed);
            
            updateDisplay();
        }

        function startLevel10Timer() {
            let timeLeft = 30;
            gameState.level10Timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(gameState.level10Timer);
                    victoryComplete();
                }
            }, 1000);
        }

        function showMissEffect() {
            const missEffect = document.getElementById('missEffect');
            missEffect.classList.add('show');
            setTimeout(() => {
                missEffect.classList.remove('show');
            }, 100);
        }

        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('speed').textContent = gameState.speed.toFixed(1) + 'x';
        }

        function updateHearts() {
            const heartElements = document.querySelectorAll('.heart');
            heartElements.forEach((heart, index) => {
                if (index < gameState.hearts) {
                    heart.classList.remove('lost');
                } else {
                    heart.classList.add('lost');
                }
            });
        }

        function gameOver() {
            gameState.isRunning = false;
            clearInterval(gameLoop);
            clearInterval(spawnLoop);
            if (gameState.level10Timer) {
                clearInterval(gameState.level10Timer);
            }
            
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalLevel').textContent = gameState.level;
            document.getElementById('totalTiles').textContent = gameState.tilesCleared;
            document.getElementById('gameOver').style.display = 'flex';
        }

        function victoryComplete() {
            gameState.isRunning = false;
            clearInterval(gameLoop);
            clearInterval(spawnLoop);
            if (gameState.level10Timer) {
                clearInterval(gameState.level10Timer);
            }
            
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalLevel').textContent = gameState.level;
            document.getElementById('totalTiles').textContent = gameState.tilesCleared;
            document.getElementById('gameOver').querySelector('h2').textContent = 'ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰';
            document.getElementById('gameOver').querySelector('h2').style.color = '#4CAF50';
            document.getElementById('gameOver').style.display = 'flex';
        }

        function gameComplete() {
            gameState.isRunning = false;
            clearInterval(gameLoop);
            clearInterval(spawnLoop);
            if (gameState.level10Timer) {
                clearInterval(gameState.level10Timer);
            }
            
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalLevel').textContent = gameState.level;
            document.getElementById('totalTiles').textContent = gameState.tilesCleared;
            document.getElementById('gameOver').querySelector('h2').textContent = 'ê²Œì„ ì™„ë£Œ!';
            document.getElementById('gameOver').querySelector('h2').style.color = '#333';
            document.getElementById('gameOver').style.display = 'flex';
        }

        function restartGame() {
            // í™”ë©´ ì´ˆê¸°í™”
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameOver').querySelector('h2').textContent = 'ê²Œì„ ì˜¤ë²„!';
            document.getElementById('instructions').style.display = 'block';
            
            // íƒ€ì¼ ì œê±°
            lanes.forEach(lane => {
                lane.innerHTML = '';
            });
            
            // ìƒíƒœ ì´ˆê¸°í™”
            gameState = {
                isRunning: false,
                score: 0,
                level: 1,
                speed: 1.0,
                tiles: [],
                nextTileId: 0,
                tilesCleared: 0,
                totalTiles: 200,
                keysPressed: [false, false, false, false],
                lastSpawnTime: [0, 0, 0, 0],
                patternIndex: 0,
                currentPattern: [],
                lastSpawnTime: [0, 0, 0, 0]
            };
            
            updateDisplay();
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        document.addEventListener('keydown', (e) => {
            const keyIndex = keys.indexOf(e.code);
            if (keyIndex !== -1 && !gameState.keysPressed[keyIndex]) {
                gameState.keysPressed[keyIndex] = true;
                keyElements[keyIndex].classList.add('pressed');
                hitTile(keyIndex);
            }
        });

        document.addEventListener('keyup', (e) => {
            const keyIndex = keys.indexOf(e.code);
            if (keyIndex !== -1) {
                gameState.keysPressed[keyIndex] = false;
                keyElements[keyIndex].classList.remove('pressed');
            }
        });

        // ë§ˆìš°ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
        keyElements.forEach((keyElement, index) => {
            keyElement.addEventListener('mousedown', () => {
                keyElement.classList.add('pressed');
                hitTile(index);
            });
            
            keyElement.addEventListener('mouseup', () => {
                keyElement.classList.remove('pressed');
            });
        });

        // ì´ˆê¸° í™”ë©´ í‘œì‹œ
        updateDisplay();
    </script>
</body>
</html>