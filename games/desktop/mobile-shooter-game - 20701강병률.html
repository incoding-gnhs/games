<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏäàÌåÖ Í≤åÏûÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            width: 100vw;
            height: 100vh;
            background-color: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #gameContainer {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #startScreen, #gameoverScreen, #winScreen {
            text-align: center;
            padding: 20px;
            color: white;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 30px;
        }

        h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .control-mode-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background-color: #4a4a4a;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        .mode-btn.active {
            background-color: #3b82f6;
        }

        .mode-btn:hover {
            opacity: 0.8;
        }

        .instructions {
            background-color: #2a2a3e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .instructions p {
            color: #d1d5db;
            margin: 8px 0;
            text-align: left;
        }

        .instructions .title {
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .start-btn, .restart-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .start-btn {
            background-color: #10b981;
            color: white;
        }

        .start-btn:hover {
            background-color: #059669;
        }

        .restart-btn {
            background-color: #3b82f6;
            color: white;
        }

        .restart-btn:hover {
            background-color: #2563eb;
        }

        #gameScreen {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 600px;
            display: none;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            background-color: #1a1a2e;
            display: block;
        }

        .hud {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hp-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hp-bar {
            width: 128px;
            height: 16px;
            background-color: #4a5568;
            border-radius: 4px;
            overflow: hidden;
        }

        .hp-bar-fill {
            height: 100%;
            background-color: #ef4444;
            transition: width 0.3s;
        }

        .score {
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .heart-icon {
            color: #ef4444;
            font-size: 1.2rem;
        }

        /* Mobile controls */
        .joystick-container {
            position: absolute;
            bottom: 32px;
            left: 32px;
            width: 128px;
            height: 128px;
            background-color: rgba(74, 74, 74, 0.5);
            border: 4px solid #4a5568;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .joystick-knob {
            width: 64px;
            height: 64px;
            background-color: rgba(59, 130, 246, 0.7);
            border-radius: 50%;
            pointer-events: none;
        }

        .mobile-controls {
            position: absolute;
            bottom: 32px;
            right: 32px;
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .control-btn {
            width: 80px;
            height: 80px;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .dash-btn {
            background-color: #a855f7;
        }

        .dash-btn.disabled {
            background-color: #4a5568;
        }

        .dash-cooldown-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #a855f7;
            transition: height 0.1s;
        }

        .fire-btn {
            background-color: #ef4444;
        }

        .dash-indicator {
            position: absolute;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            display: none;
        }

        .final-score {
            color: #d1d5db;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .win-title {
            color: #fbbf24;
        }

        .skull-icon {
            color: #ef4444;
            font-size: 4rem;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.8rem;
            }

            #gameScreen {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Start Screen -->
        <div id="startScreen">
            <h1>ÏäàÌåÖ Í≤åÏûÑ</h1>

            <div class="instructions">
                <div id="pcInstructions">
                    <p class="title">üñ•Ô∏è PC Ï°∞ÏûëÎ≤ï:</p>
                    <p>‚Ä¢ WASD / Î∞©Ìñ•ÌÇ§ - Ïù¥Îèô</p>
                    <p>‚Ä¢ ÎßàÏö∞Ïä§ - Ï°∞Ï§Ä</p>
                    <p>‚Ä¢ ÎßàÏö∞Ïä§ Ï¢åÌÅ¥Î¶≠ - Î∞úÏÇ¨</p>
                    <p>‚Ä¢ Ïä§ÌéòÏù¥Ïä§Î∞î / Q - ÎåÄÏâ¨</p>
                </div>
            </div>

            <button class="start-btn" onclick="startGame()">Í≤åÏûÑ ÏãúÏûë</button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen">
            <canvas id="gameCanvas" width="400" height="600"></canvas>
            
            <div class="hud">
                <div class="hp-bar-container">
                    <span class="heart-icon">‚ù§Ô∏è</span>
                    <div class="hp-bar">
                        <div class="hp-bar-fill" id="hpBar" style="width: 100%;"></div>
                    </div>
                </div>
                <div class="score">Ï†êÏàò: <span id="scoreDisplay">0</span></div>
            </div>

            <div class="joystick-container" id="joystick">
                <div class="joystick-knob"></div>
            </div>

            <div class="mobile-controls" id="mobileControls">
                <button class="control-btn dash-btn" id="dashBtn">
                    <span style="position: relative; z-index: 1;">‚ö°</span>
                    <div class="dash-cooldown-fill" id="dashCooldownFill"></div>
                </button>
                <button class="control-btn fire-btn" id="fireBtn">üéØ</button>
            </div>

            <div class="dash-indicator" id="dashIndicator">
                ÎåÄÏâ¨: <span id="dashText">Ï§ÄÎπÑÎê®</span>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameoverScreen" style="display: none;">
            <div class="skull-icon">üíÄ</div>
            <h2>Í≤åÏûÑ Ïò§Î≤Ñ</h2>
            <p class="final-score">ÏµúÏ¢Ö Ï†êÏàò: <span id="finalScoreGameover">0</span></p>
            <button class="restart-btn" onclick="startGame()">Îã§Ïãú ÏãúÏûë</button>
        </div>

        <!-- Win Screen -->
        <div id="winScreen" style="display: none;">
            <h2 class="win-title">ÏäπÎ¶¨!</h2>
            <p class="final-score">ÏµúÏ¢Ö Ï†êÏàò: <span id="finalScoreWin">0</span></p>
            <button class="restart-btn" onclick="startGame()">Îã§Ïãú ÏãúÏûë</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let gameState = 'start';
        let controlMode = 'pc';
        let isMobile = false;
        let score = 0;

        const game = {
            player: { x: 200, y: 300, size: 12, hp: 100, maxHp: 100, speed: 4 },
            boss: { x: 200, y: 100, size: 30, hp: 1000, maxHp: 1000, speed: 4.5, direction: 1, movePattern: 0, patternTimer: 0 },
            bullets: [],
            bossBullets: [],
            joystick: { active: false, startX: 0, startY: 0, currentX: 0, currentY: 0 },
            dashCooldown: 0,
            dashDuration: 0,
            fireButton: { active: false },
            lastFireTime: 0,
            bossLastFireTime: 0,
            bossPattern: 0,
            keys: {},
            mouseX: 200,
            mouseY: 300
        };

        let animationId = null;

        function checkMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || window.innerWidth < 768;
        }

        function setControlMode(mode) {
            controlMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (mode === 'auto') {
                isMobile = checkMobile();
            } else {
                isMobile = mode === 'mobile';
            }

            updateInstructions();
        }

        function updateInstructions() {
            if (isMobile) {
                document.getElementById('pcInstructions').style.display = 'none';
                document.getElementById('mobileInstructions').style.display = 'block';
            } else {
                document.getElementById('pcInstructions').style.display = 'block';
                document.getElementById('mobileInstructions').style.display = 'none';
            }
        }

        function startGame() {
            // Reset game state
            game.player = { x: 200, y: 300, size: 12, hp: 100, maxHp: 100, speed: 4 };
            game.boss = { x: 200, y: 100, size: 30, hp: 1000, maxHp: 1000, speed: 4.5, direction: 1, movePattern: 0, patternTimer: 0 };
            game.bullets = [];
            game.bossBullets = [];
            game.dashCooldown = 0;
            game.dashDuration = 0;
            game.lastFireTime = 0;
            game.bossLastFireTime = 0;
            game.bossPattern = 0;
            game.keys = {};
            score = 0;

            // PC mode only
            isMobile = false;

            // Show/hide UI
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameoverScreen').style.display = 'none';
            document.getElementById('winScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';

            document.getElementById('joystick').style.display = 'none';
            document.getElementById('mobileControls').style.display = 'none';
            document.getElementById('dashIndicator').style.display = 'block';

            gameState = 'playing';
            gameLoop();
        }

        function gameLoop() {
            if (gameState !== 'playing') return;

            // Clear canvas
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // PC Movement
            if (!isMobile) {
                const speed = game.dashDuration > 0 ? game.player.speed * 3 : game.player.speed;
                if (game.keys['w'] || game.keys['arrowup']) game.player.y -= speed;
                if (game.keys['s'] || game.keys['arrowdown']) game.player.y += speed;
                if (game.keys['a'] || game.keys['arrowleft']) game.player.x -= speed;
                if (game.keys['d'] || game.keys['arrowright']) game.player.x += speed;
            }
            // Mobile joystick movement
            else if (game.joystick.active) {
                const dx = game.joystick.currentX - game.joystick.startX;
                const dy = game.joystick.currentY - game.joystick.startY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 10) {
                    const speed = game.dashDuration > 0 ? game.player.speed * 3 : game.player.speed;
                    game.player.x += (dx / distance) * speed;
                    game.player.y += (dy / distance) * speed;
                }
            }

            // Keep player in bounds
            game.player.x = Math.max(game.player.size, Math.min(canvas.width - game.player.size, game.player.x));
            game.player.y = Math.max(game.player.size, Math.min(canvas.height - game.player.size, game.player.y));

            // Dash cooldown
            if (game.dashCooldown > 0) game.dashCooldown--;
            if (game.dashDuration > 0) game.dashDuration--;

            // Update dash UI
            const dashReady = game.dashCooldown === 0;
            const dashCooldownPercent = (1 - game.dashCooldown / 180) * 100;
            
            if (isMobile) {
                const dashBtn = document.getElementById('dashBtn');
                dashBtn.className = dashReady ? 'control-btn dash-btn' : 'control-btn dash-btn disabled';
                document.getElementById('dashCooldownFill').style.height = dashCooldownPercent + '%';
            } else {
                const dashText = dashReady ? 'Ï§ÄÎπÑÎê®' : `${Math.ceil(game.dashCooldown / 60)}Ï¥à`;
                document.getElementById('dashText').textContent = dashText;
            }

            // Boss movement
            game.boss.patternTimer++;
            
            if (game.boss.patternTimer > 300) {
                game.boss.patternTimer = 0;
                game.boss.movePattern = (game.boss.movePattern + 1) % 4;
            }

            if (game.boss.movePattern === 0) {
                game.boss.x += game.boss.speed * game.boss.direction;
                if (game.boss.x < game.boss.size + 50 || game.boss.x > canvas.width - game.boss.size - 50) {
                    game.boss.direction *= -1;
                }
            } else if (game.boss.movePattern === 1) {
                const t = game.boss.patternTimer / 50;
                game.boss.x = canvas.width / 2 + Math.sin(t) * 120;
                game.boss.y = 100 + Math.sin(t * 2) * 40;
            } else if (game.boss.movePattern === 2) {
                const dx = game.player.x - game.boss.x;
                const dy = game.player.y - game.boss.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > 150) {
                    game.boss.x += (dx / dist) * (game.boss.speed * 0.5);
                    game.boss.y += (dy / dist) * (game.boss.speed * 0.5);
                }
            } else if (game.boss.movePattern === 3) {
                const t = game.boss.patternTimer / 30;
                game.boss.x = canvas.width / 2 + Math.cos(t) * 100;
                game.boss.y = 120 + Math.sin(t) * 60;
            }

            game.boss.x = Math.max(game.boss.size, Math.min(canvas.width - game.boss.size, game.boss.x));
            game.boss.y = Math.max(game.boss.size, Math.min(canvas.height / 3, game.boss.y));

            // Boss shooting
            const now = Date.now();
            if (now - game.bossLastFireTime > 800) {
                game.bossPattern = (game.bossPattern + 1) % 4;
                
                if (game.bossPattern === 0) {
                    const angle = Math.atan2(game.player.y - game.boss.y, game.player.x - game.boss.x);
                    game.bossBullets.push({
                        x: game.boss.x,
                        y: game.boss.y + game.boss.size / 2,
                        vx: Math.cos(angle) * 5,
                        vy: Math.sin(angle) * 5,
                        size: 6
                    });
                } else if (game.bossPattern === 1) {
                    const baseAngle = Math.atan2(game.player.y - game.boss.y, game.player.x - game.boss.x);
                    for (let i = -1; i <= 1; i++) {
                        const angle = baseAngle + (i * 0.3);
                        game.bossBullets.push({
                            x: game.boss.x,
                            y: game.boss.y + game.boss.size / 2,
                            vx: Math.cos(angle) * 4.5,
                            vy: Math.sin(angle) * 4.5,
                            size: 5
                        });
                    }
                } else if (game.bossPattern === 2) {
                    for (let i = 0; i < 8; i++) {
                        const angle = (Math.PI * 2 * i) / 8 + (now / 1000);
                        game.bossBullets.push({
                            x: game.boss.x,
                            y: game.boss.y,
                            vx: Math.cos(angle) * 3.5,
                            vy: Math.sin(angle) * 3.5,
                            size: 5
                        });
                    }
                } else {
                    for (let i = 0; i < 3; i++) {
                        const angle = (now / 500) + (i * Math.PI * 2 / 3);
                        game.bossBullets.push({
                            x: game.boss.x,
                            y: game.boss.y,
                            vx: Math.cos(angle) * 4,
                            vy: Math.sin(angle) * 4,
                            size: 5
                        });
                    }
                }
                game.bossLastFireTime = now;
            }

            // Player shooting
            if (game.fireButton.active && now - game.lastFireTime > 200) {
                let targetX, targetY;
                
                if (isMobile) {
                    targetX = game.boss.x;
                    targetY = game.boss.y;
                } else {
                    targetX = game.mouseX;
                    targetY = game.mouseY;
                }
                
                const angle = Math.atan2(targetY - game.player.y, targetX - game.player.x);
                const perpAngle = angle + Math.PI / 2;
                const offset = 6;
                
                game.bullets.push({
                    x: game.player.x + Math.cos(perpAngle) * offset,
                    y: game.player.y + Math.sin(perpAngle) * offset,
                    vx: Math.cos(angle) * 8,
                    vy: Math.sin(angle) * 8,
                    size: 5
                });
                
                game.bullets.push({
                    x: game.player.x - Math.cos(perpAngle) * offset,
                    y: game.player.y - Math.sin(perpAngle) * offset,
                    vx: Math.cos(angle) * 8,
                    vy: Math.sin(angle) * 8,
                    size: 5
                });
                
                game.lastFireTime = now;
            }

            // Update bullets
            game.bullets = game.bullets.filter(b => {
                b.x += b.vx;
                b.y += b.vy;
                
                const dist = Math.sqrt((b.x - game.boss.x) ** 2 + (b.y - game.boss.y) ** 2);
                if (dist < game.boss.size) {
                    game.boss.hp -= 5;
                    score += 5;
                    document.getElementById('scoreDisplay').textContent = score;
                    return false;
                }
                
                return b.x > 0 && b.x < canvas.width && b.y > 0 && b.y < canvas.height;
            });

            // Update boss bullets
            game.bossBullets = game.bossBullets.filter(b => {
                b.x += b.vx;
                b.y += b.vy;
                
                if (game.dashDuration === 0) {
                    const dist = Math.sqrt((b.x - game.player.x) ** 2 + (b.y - game.player.y) ** 2);
                    if (dist < game.player.size) {
                        game.player.hp -= 15;
                        const hpPercent = (game.player.hp / game.player.maxHp) * 100;
                        document.getElementById('hpBar').style.width = hpPercent + '%';
                        return false;
                    }
                }
                
                return b.x > 0 && b.x < canvas.width && b.y > 0 && b.y < canvas.height;
            });

            // Draw boss
            const bossAngry = game.boss.hp < game.boss.maxHp / 2;
            
            const gradient = ctx.createRadialGradient(game.boss.x, game.boss.y, 0, game.boss.x, game.boss.y, game.boss.size);
            gradient.addColorStop(0, bossAngry ? '#ff1744' : '#ff6b6b');
            gradient.addColorStop(1, bossAngry ? '#8b0000' : '#d32f2f');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(game.boss.x, game.boss.y, game.boss.size, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = bossAngry ? '#fff' : '#ffeb3b';
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI * 2 * i) / 6 + (Date.now() / 500);
                const spikeX = game.boss.x + Math.cos(angle) * game.boss.size;
                const spikeY = game.boss.y + Math.sin(angle) * game.boss.size;
                const tipX = game.boss.x + Math.cos(angle) * (game.boss.size + 12);
                const tipY = game.boss.y + Math.sin(angle) * (game.boss.size + 12);
                
                ctx.beginPath();
                ctx.moveTo(spikeX - 3, spikeY);
                ctx.lineTo(tipX, tipY);
                ctx.lineTo(spikeX + 3, spikeY);
                ctx.fill();
            }
            
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.moveTo(game.boss.x - 12, game.boss.y - 8);
            ctx.lineTo(game.boss.x - 8, game.boss.y - 12);
            ctx.lineTo(game.boss.x - 4, game.boss.y - 8);
            ctx.lineTo(game.boss.x - 8, game.boss.y - 4);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(game.boss.x + 12, game.boss.y - 8);
            ctx.lineTo(game.boss.x + 8, game.boss.y - 12);
            ctx.lineTo(game.boss.x + 4, game.boss.y - 8);
            ctx.lineTo(game.boss.x + 8, game.boss.y - 4);
            ctx.fill();
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(game.boss.x, game.boss.y + 5, 15, 0.2, Math.PI - 0.2);
            ctx.stroke();
            
            if (bossAngry) {
                ctx.strokeStyle = 'rgba(255, 23, 68, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(game.boss.x, game.boss.y, game.boss.size + 5 + Math.sin(Date.now() / 100) * 3, 0, Math.PI * 2);
                ctx.stroke();
            }

            // Boss HP bar
            ctx.fillStyle = '#333';
            ctx.fillRect(game.boss.x - 50, game.boss.y - game.boss.size - 20, 100, 10);
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(game.boss.x - 50, game.boss.y - game.boss.size - 20, (game.boss.hp / game.boss.maxHp) * 100, 10);

            // Draw player
            if (game.dashDuration > 0) {
                ctx.fillStyle = 'rgba(100, 200, 255, 0.5)';
                ctx.beginPath();
                ctx.arc(game.player.x, game.player.y, game.player.size + 10, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.fillStyle = game.dashDuration > 0 ? '#64c8ff' : '#4ecdc4';
            ctx.beginPath();
            ctx.arc(game.player.x, game.player.y, game.player.size, 0, Math.PI * 2);
            ctx.fill();

            // Draw crosshair (PC only)
            if (!isMobile) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(game.mouseX, game.mouseY, 10, 0, Math.PI * 2);
                ctx.moveTo(game.mouseX - 15, game.mouseY);
                ctx.lineTo(game.mouseX - 5, game.mouseY);
                ctx.moveTo(game.mouseX + 5, game.mouseY);
                ctx.lineTo(game.mouseX + 15, game.mouseY);
                ctx.moveTo(game.mouseX, game.mouseY - 15);
                ctx.lineTo(game.mouseX, game.mouseY - 5);
                ctx.moveTo(game.mouseX, game.mouseY + 5);
                ctx.lineTo(game.mouseX, game.mouseY + 15);
                ctx.stroke();
            }

            // Draw bullets
            ctx.fillStyle = '#ffeb3b';
            game.bullets.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.size, 0, Math.PI * 2);
                ctx.fill();
            });

            ctx.fillStyle = '#ff5252';
            game.bossBullets.forEach(b => {
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.size, 0, Math.PI * 2);
                ctx.fill();
            });

            // Check win/lose
            if (game.boss.hp <= 0) {
                gameState = 'win';
                document.getElementById('finalScoreWin').textContent = score;
                document.getElementById('gameScreen').style.display = 'none';
                document.getElementById('winScreen').style.display = 'block';
                return;
            }
            if (game.player.hp <= 0) {
                gameState = 'gameover';
                document.getElementById('finalScoreGameover').textContent = score;
                document.getElementById('gameScreen').style.display = 'none';
                document.getElementById('gameoverScreen').style.display = 'block';
                return;
            }

            animationId = requestAnimationFrame(gameLoop);
        }

        // PC Controls
        window.addEventListener('keydown', (e) => {
            if (gameState !== 'playing' || isMobile) return;
            
            const key = e.key.toLowerCase();
            game.keys[key] = true;
            
            if (e.key === ' ' || key === 'q') {
                e.preventDefault();
                if (game.dashCooldown === 0) {
                    game.dashDuration = 20;
                    game.dashCooldown = 180;
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            if (gameState !== 'playing' || isMobile) return;
            
            const key = e.key.toLowerCase();
            game.keys[key] = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (gameState !== 'playing' || isMobile) return;
            
            const rect = canvas.getBoundingClientRect();
            game.mouseX = ((e.clientX - rect.left) / rect.width) * canvas.width;
            game.mouseY = ((e.clientY - rect.top) / rect.height) * canvas.height;
        });

        canvas.addEventListener('mousedown', () => {
            if (gameState !== 'playing' || isMobile) return;
            game.fireButton.active = true;
        });

        canvas.addEventListener('mouseup', () => {
            if (gameState !== 'playing' || isMobile) return;
            game.fireButton.active = false;
        });

        // Mobile Controls
        const joystick = document.getElementById('joystick');
        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            game.joystick.active = true;
            game.joystick.startX = touch.clientX;
            game.joystick.startY = touch.clientY;
            game.joystick.currentX = touch.clientX;
            game.joystick.currentY = touch.clientY;
        });

        joystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!game.joystick.active) return;
            const touch = e.touches[0];
            game.joystick.currentX = touch.clientX;
            game.joystick.currentY = touch.clientY;
        });

        joystick.addEventListener('touchend', (e) => {
            e.preventDefault();
            game.joystick.active = false;
        });

        const fireBtn = document.getElementById('fireBtn');
        fireBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            game.fireButton.active = true;
        });

        fireBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            game.fireButton.active = false;
        });

        const dashBtn = document.getElementById('dashBtn');
        dashBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (game.dashCooldown === 0) {
                game.dashDuration = 20;
                game.dashCooldown = 180;
            }
        });

        // Initialize
        if (controlMode === 'auto') {
            isMobile = checkMobile();
        }
        updateInstructions();
    </script>
</body>
</html>